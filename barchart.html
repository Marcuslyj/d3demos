<!DOCTYPE html><html>
 <head>  <meta charset="UTF-8">  <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no,minimum-scale=1.0, maximum-scale=1.0">  <title></title>  <link rel="stylesheet" type="text/css" href="css/styles.css" />  <style>   .bar {    fill: steelblue;   }      .axis text {    font-size: .5rem;   }      .axis path,   .axis line {    fill: none;    stroke: #000;    shape-rendering: crispEdges;   }      .x.axis text {    transform: rotate(-28deg);    text-anchor: end !important;   }      g.g_line {    opacity: 0;   }      .grid-wrapper {    margin-top: 3rem;    width: 100%;   }      .grid-wrapper tr {    margin-top: 1rem;    text-align: center;    vertical-align: top;    font-size: 0;   }      .grid-wrapper td {    padding: 0 .2rem;   }      .grid-wrapper tr:nth-child(2n+1) {    font-size: .768rem;    line-height: 1.1;   }      .grid-wrapper tr:nth-child(2n+1) td {    padding-top: .5rem;   }      .grid-wrapper tr:nth-child(2n) {    font-size: .768rem;   }      .no_display {    display: none;   }  </style> </head>
 <body>  <svg class="chart"></svg>
  <table class="grid-wrapper">   <tbody>    <tr>     <td>额度可用敞口<br>（万元）</td>     <td>额度预留敞口<br>（万元）</td>     <td>未结清敞口余额<br>（万元）</td>    </tr>    <tr>     <td>500,000</td>     <td>0</td>     <td>599,521</td>    </tr>    <tr>     <td>半年内已审批未登记的授信<br>（万元）</td>     <td>对外担保<br>（万元）</td>     <td>被他人担保<br>（万元）</td>    </tr>    <tr>     <td>200,000</td>     <td>100,000</td>     <td>300,000</td>    </tr>   </tbody>  </table>
  <table class="grid-wrapper">   <tbody>    <tr>     <td>额度可用敞口（万元）</td>     <td>额度预留敞口（万元）</td>     <td>未结清敞口余额（万元）</td>    </tr>    <tr>     <td>500,000</td>     <td>0</td>     <td>599,521</td>    </tr>    <tr>     <td>半年内已审批未登记的授信（万元）</td>     <td>对外担保（万元）</td>     <td>被他人担保（万元）</td>    </tr>    <tr>     <td>200,000</td>     <td>100,000</td>     <td>300,000</td>    </tr>   </tbody>  </table>
  <script src="js/d3.min.js" type="text/javascript" charset="utf-8"></script>  <script type="text/javascript">   windowWidth = window.innerWidth;   console.log(d3.select("body").style("font-size"));   var margin = {     top: windowWidth * .1,     right: windowWidth * .05,     bottom: windowWidth * .1,     left: windowWidth * .12    },    width = windowWidth - margin.left - margin.right,    height = windowWidth * .8 - margin.top - margin.bottom;   var tagWidth = width * .15;   var tagHeight = width * .1;   var tagGap = width * .02;
   var x = d3.scale.ordinal()    .rangeRoundBands([0, width], .2);   var y = d3.scale.linear()    .range([height, 0]);
   var chart = d3.select(".chart")    .attr("width", width + margin.left + margin.right)    .attr("height", height + margin.top + margin.bottom)    .append("g")    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
   var xAxis = d3.svg.axis()    .scale(x)    .orient("bottom");
   var yAxis = d3.svg.axis()    .scale(y)    .orient("left");
   var data = [{    name: "自营贷款",    amount: 50000   }, {    name: "自营非标",    amount: 149000   }, {    name: "自营债券",    amount: 200100   }, {    name: "其他表内",    amount: 15000   }, {    name: "担保及承诺",    amount: 200000   }, {    name: "委托贷款",    amount: 20000   }, {    name: "理财出资业务",    amount: 100000   }, {    name: "代销信托",    amount: 50000   }, {    name: "债券承销",    amount: 60000   }, {    name: "其他表外",    amount: 100000   }, {    name: "账销案存",    amount: 90000   }];
   x.domain(data.map(function(d) {    return d.name;   }));//   y.domain([0, d3.max(data, function(d) {//    return d.amount;//   })]);   var y_max = d3.max(data, function(d) {    return d.amount;   });   var y_remainter = y_max%20000;   var y_domain = [];   console.log(y_max);   if(0==y_remainter){    y_domain = [0,y_max+20000];   }else{    y_domain = [0,20000%y_remainter+y_max];   }   y.domain(y_domain);   
   chart.append("g")    .attr("class", "x axis")    .attr("transform", "translate(0," + height + ")")    .call(xAxis);   chart.append("g")    .attr("class", "y axis")    .call(yAxis);   var g_bar = chart.append("g")    .classed("g_bar", true);   var bar = g_bar.selectAll(".bar")    .data(data)    .enter().append("rect")    .attr("class", "bar")    .attr("x", function(d) {     return x(d.name);    })    .attr("y", height)    .attr("height", 0)    .attr("width", x.rangeBand())    .transition().ease("linear").duration(300)    .attr("y", function(d) {     return y(d.amount);    })    .attr("height", function(d) {     return height - y(d.amount);    });
   var targetLine = chart.append("g").classed("g_line", true);      var g_tag = targetLine.append("g").classed("g_tag", true);
   var valTagRect = g_tag.append("rect").classed("valTag", true);   valTagRect    .attr("x", tagGap)    .attr("y", 0)    .attr("width", tagWidth)    .attr("height", tagHeight)    .attr("rx", tagWidth * .1)    .attr("fill", "rgba(0,0,0,.5)");   targetLine.append("line")    .attr("x1", "0")    .attr("y1", "-.6rem")    .attr("x2", "0")    .attr("y2", height)    .attr("stroke", "red")    .attr("stroke-dasharray", "5 5");var rightArrow = targetLine.append("polygon").classed("right-arrow".true)    .attr("fill", "rgba(0,0,0,.5)")    .attr("points", `0,${tagHeight/2} ${tagGap*1.1},${tagHeight/2-tagGap} ${tagGap*1.1},${tagHeight/2+tagGap}`);   var leftArrow = targetLine.append("polygon").classed("left-arrow".true)    .attr("fill", "rgba(0,0,0,.5)")    .attr("points", `0,${tagHeight/2} ${-tagGap*1.1},${tagHeight/2-tagGap} ${-tagGap*1.1},${tagHeight/2+tagGap}`);       var targetText = g_tag.append("text").classed("valText", true)    .text("")    .attr("transform", "translate(" + (tagGap + tagWidth / 2) + "," + tagHeight / 2 + ")")    .style("text-anchor", "middle")    .attr("fill", "white")    .style("font-size", ".65rem");
   var svg = d3.select(".chart");   svg.on("touchstart", function() {    showTargetLine();
   });   svg.on("touchmove", function() {    showTargetLine();   });
   svg.on("touchend", function() {    targetLine     .style("transition", "2s")     .style("opacity", 0);   });
   function showTargetLine() {    //判断在纵坐标右边 或者减去margin.left和svg的left    var clientX = d3.event["changedTouches"][0].clientX - margin.left;    if (clientX < 0) {     return;    }    targetLine     .style("transition", "0s")     .style("opacity", 1);    //寻找最近的rect    var rects = g_bar.selectAll(".bar");    var targetRect;    var lastDelta;    rects.each(function(d, e) {     var thisRect = d3.select(this);     var centerLineX = Number(thisRect.attr("x")) + thisRect.attr("width") / 2;     var index;     if (!targetRect) {      targetRect = thisRect;      lastDelta = Math.abs(clientX - centerLineX);     }     var newDelta = Math.abs(clientX - centerLineX);     if (newDelta <= lastDelta) {      lastDelta = newDelta;      targetRect = thisRect;      rects.classed("target", false);      thisRect.classed("target", true);      targetLine.attr("transform", "translate(" + centerLineX + ",0)");
      targetText.text(d.amount);      //过半      if (e > rects[0].length / 2) {       g_tag.attr("transform", "translate(" + -(tagGap * 2 + tagWidth) + ",0)");       leftArrow.classed("no_display", false);       rightArrow.classed("no_display", true);      } else {       g_tag.attr("transform", "translate(0,0)");       leftArrow.classed("no_display", true);       rightArrow.classed("no_display", false);      }     }    });   }  </script> </body>
</html>
